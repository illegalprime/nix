SOCKET="/tmp/shell_sessions/session-$$"
GLOBAL_THEME="/tmp/global-theme"

konsole_light() {
    konsoleprofile colors=BlackOnYellow
}

konsole_dark() {
    konsoleprofile colors=Breeze
}

switch_theme() {
    local theme="$1"
    case "$theme" in
        dark)
            konsole_dark
            ;;
        light)
            konsole_light
            ;;
    esac
}

start_watcher() {
    tail -F "$SOCKET" | while read LINE; do
        switch_theme "$LINE"
    done
}

cleanup() {
    rm -f "$SOCKET"
}

init_konsole_watcher() {
    mkdir -p "$(dirname "$SOCKET")"
    mkfifo "$SOCKET"

    if [[ -f $GLOBAL_THEME ]]; then
        switch_theme "$(cat "$GLOBAL_THEME")"
    fi
}

init_konsole_watcher
( start_watcher & ) 2>/dev/null
trap cleanup EXIT INT TERM
